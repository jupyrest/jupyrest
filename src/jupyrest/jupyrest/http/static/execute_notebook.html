<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <link rel="stylesheet" data-name="vs/editor/editor.main"
        href="/static/monaco-editor/min/vs/editor/editor.main.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

    <script>
        var require = { paths: { vs: '/static/monaco-editor/min/vs' } };
    </script>
    <script src="/static/monaco-editor/min/vs/loader.js"></script>
    <script src="/static/monaco-editor/min/vs/editor/editor.main.nls.js"></script>
    <script src="/static/monaco-editor/min/vs/editor/editor.main.js"></script>
</head>

<body>
    <div class="container mt-5">
        <h2>Submit Notebook Execution</h2>
        <form id="notebookForm">
            <div class="mb-3">
                <label for="notebookName" class="form-label">Notebook Name</label>
                <select class="form-select" id="notebookName" name="notebookName" required>
                    <!-- <option value="" disabled hidden>Select a notebook</option> -->
                </select>
            </div>
            <div class="mb-3">
                <label for="parameters" class="form-label">Parameters</label>
                <div id="container" style="height: 200px; border: 1px solid grey"></div>
            </div>
            <button type="submit" class="btn btn-primary" id="submitButton">Submit</button>
            <div class="spinner-border text-primary mt-2 d-none" role="status" id="loadingSpinner">
                <span class="visually-hidden">Loading...</span>
            </div>
        </form>
    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorModalLabel">Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="errorModalBody"></div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="successModalLabel">Success</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="successModalBody"></div>
            </div>
        </div>
    </div>

    <script>

        // Data from query params
        const urlParams = new URLSearchParams(window.location.search);
        const preSelectedNotebook = urlParams.get('notebook');
        //

        monaco.languages.json.jsonDefaults.diagnosticsOptions.enableSchemaRequest = true;
        var editor = monaco.editor.create(document.getElementById('container'), {
            value: ['{', '}'].join('\n'),
            language: 'json',
        });

        var notebookSelect = document.getElementById("notebookName");

        // Fetch notebook options and populate the dropdown
        fetch("/api/Notebooks")
            .then(response => response.json())
            .then(data => {
                data.notebooks.forEach(notebook => {
                    var option = document.createElement("option");
                    option.value = notebook;
                    option.text = notebook;
                    if (notebook == preSelectedNotebook) {
                        option.selected = true;
                    }
                    notebookSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error("Error fetching notebook options:", error);
            });

        document.getElementById("notebookForm").addEventListener("submit", function (event) {
            event.preventDefault();

            // Show loading spinner
            document.getElementById("submitButton").disabled = true;
            document.getElementById("loadingSpinner").classList.remove("d-none");

            var notebookName = document.getElementById("notebookName").value;
            var parameters = editor.getValue();

            var requestBody = {
                notebook: notebookName,
                parameters: JSON.parse(parameters)
            };

            fetch("/api/NotebookExecutions", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(requestBody)
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(JSON.stringify(errorData));
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Response:", data);
                    // Prettify and format JSON response
                    var formattedResponse = JSON.stringify(data, null, 2);

                    // Construct hyperlinks for executionId and output
                    var executionId = data.id;
                    var viewHtmlLink = `/api/NotebookExecutions?executionId=${executionId}&view_html=true`;
                    var getOutputLink = `/api/NotebookExecutions?executionId=${executionId}&output=true`;

                    // Construct modal content with formatted JSON and hyperlinks
                    var modalContent = `<pre>${formattedResponse}</pre>`;
                    modalContent += `<p><a href="${viewHtmlLink}" target="_blank">View Notebook HTML</a></p>`;
                    modalContent += `<p><a href="${getOutputLink}" target="_blank">View Notebook Response</a></p>`;

                    // Show success modal with formatted JSON and hyperlinks
                    document.getElementById("successModalBody").innerHTML = modalContent;
                    var successModal = new bootstrap.Modal(document.getElementById('successModal'), {
                        keyboard: false
                    });
                    successModal.show();
                })
                .catch(error => {
                    console.error("Error:", error);
                    // Show error modal
                    document.getElementById("errorModalBody").textContent = error.message;
                    var errorModal = new bootstrap.Modal(document.getElementById('errorModal'), {
                        keyboard: false
                    });
                    errorModal.show();
                })
                .finally(() => {
                    // Hide loading spinner
                    document.getElementById("submitButton").disabled = false;
                    document.getElementById("loadingSpinner").classList.add("d-none");
                });
        });
    </script>
</body>

</html>